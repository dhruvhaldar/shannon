<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shannon Mission Control</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div class="container">
        <header>
            <h1>Shannon Mission Control</h1>
            <p>Virtual Ground Station & Operations Center</p>
        </header>

        <main class="dashboard" id="main-content" tabindex="-1">
            <div class="panel" id="link-budget-panel">
                <h2>Link Budget Calculator</h2>
                <form id="link-budget-form">
                    <label><span>Frequency (Hz)<small id="freq-helper"></small>:</span> <input type="number" id="freq" value="2400000000" required step="any" min="0"></label>
                    <label>Distance (km): <input type="number" id="dist" value="600" required step="any" min="0"></label>
                    <label><span>Tx Power (dBm)<small id="pwr-helper"></small>:</span> <input type="number" id="tx_pwr" value="30" required step="any"></label>
                    <label>Tx Cable Loss (dB): <input type="number" id="tx_loss" value="1" required step="any" min="0"></label>
                    <label>Tx Antenna Gain (dBi): <input type="number" id="tx_gain" value="0" required step="any"></label>
                    <label>Atmosphere Loss (dB): <input type="number" id="atm_loss" value="0.5" required step="any" min="0"></label>
                    <label>Rx Antenna Gain (dBi): <input type="number" id="rx_gain" value="15" required step="any"></label>
                    <label>Rx Noise Temp (K): <input type="number" id="rx_temp" value="150" required step="any" min="0"></label>
                    <label><span>Data Rate (bps)<small id="rate-helper"></small>:</span> <input type="number" id="rate" value="9600" required step="any" min="0"></label>
                    <label>Req. Eb/N0 (dB): <input type="number" id="req_ebno" value="10" required step="any"></label>
                    <button type="submit">Calculate Margin</button>
                </form>
                <div id="link-result" aria-live="polite"></div>
            </div>

            <div class="panel" id="pass-predict-panel">
                <h2>Pass Prediction</h2>
                <form id="pass-form">
                    <label>TLE Line 1: <input type="text" id="tle1" value="1 33591U 09005A   20265.56828552  .00000055  00000-0  57632-4 0  9995" required></label>
                    <label>TLE Line 2: <input type="text" id="tle2" value="2 33591  99.1989 123.6338 0013952 147.2885 212.9238 14.12351659595519" required></label>
                    <label>Lat: <input type="number" id="lat" value="59.3498" required step="any" min="-90" max="90"></label>
                    <label>Lon: <input type="number" id="lon" value="18.0707" required step="any" min="-180" max="180"></label>
                    <label>Alt (m): <input type="number" id="alt" value="10" required step="any" min="0"></label>
                    <button type="submit">Predict Next Pass</button>
                </form>
                <div id="skyplot" aria-live="polite"></div>
            </div>

            <div class="panel" id="iq-panel">
                <h2>IQ Constellation</h2>
                <form id="iq-form">
                    <label>Scheme:
                        <select id="scheme">
                            <option value="BPSK">BPSK</option>
                            <option value="QPSK">QPSK</option>
                            <option value="16-QAM">16-QAM</option>
                        </select>
                    </label>
                    <label>SNR (dB): <input type="number" id="snr" value="15" required step="any"></label>
                    <button type="submit">Visualize</button>
                </form>
                <canvas id="iq-canvas" width="300" height="300"></canvas>
                <p id="iq-status" aria-live="polite" style="margin-top: 10px; font-weight: bold; text-align: center;"></p>
            </div>
        </main>
    </div>
    <script src="skyplot.js"></script>
    <script src="constellations.js"></script>
    <script>
        // Helper to format error messages
        async function handleResponse(res) {
            if (!res.ok) {
                const errorData = await res.json();
                let msg = 'Server Error';
                if (errorData.detail) {
                     if (Array.isArray(errorData.detail)) {
                         msg = errorData.detail.map(e => `${e.loc.join('.')}: ${e.msg}`).join(', ');
                     } else {
                         msg = errorData.detail;
                     }
                } else if (errorData.error) {
                    msg = errorData.error;
                }
                throw new Error(msg);
            }
            return res.json();
        }

        // Link Budget Form Handler
        document.getElementById('link-budget-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.setAttribute('aria-busy', 'true');
            btn.innerHTML = '<span class="spinner"></span> Calculating...';

            try {
                const data = {
                    frequency: parseFloat(document.getElementById('freq').value),
                    distance_km: parseFloat(document.getElementById('dist').value),
                    tx_power_dbm: parseFloat(document.getElementById('tx_pwr').value),
                    tx_cable_loss: parseFloat(document.getElementById('tx_loss').value),
                    tx_antenna_gain: parseFloat(document.getElementById('tx_gain').value),
                    atmosphere_loss: parseFloat(document.getElementById('atm_loss').value),
                    rx_antenna_gain: parseFloat(document.getElementById('rx_gain').value),
                    rx_noise_temp: parseFloat(document.getElementById('rx_temp').value),
                    data_rate: parseFloat(document.getElementById('rate').value),
                    required_eb_no: parseFloat(document.getElementById('req_ebno').value)
                };

                const res = await fetch('/calculate-link-budget', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await handleResponse(res);

                let html = `<h3>Margin: ${result.margin_db.toFixed(2)} dB</h3><ul>`;
                result.losses.forEach(l => {
                    html += `<li>${l[0]}: ${l[1].toFixed(2)} dB</li>`;
                });
                html += '</ul>';
                document.getElementById('link-result').innerHTML = html;
            } catch (err) {
                console.error(err);
                document.getElementById('link-result').innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.removeAttribute('aria-busy');
                btn.innerText = originalText;
            }
        });

        // Pass Prediction Form Handler
        document.getElementById('pass-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.setAttribute('aria-busy', 'true');
            btn.innerHTML = '<span class="spinner"></span> Predicting...';

            try {
                const data = {
                    tle_line1: document.getElementById('tle1').value,
                    tle_line2: document.getElementById('tle2').value,
                    lat: parseFloat(document.getElementById('lat').value),
                    lon: parseFloat(document.getElementById('lon').value),
                    alt: parseFloat(document.getElementById('alt').value)
                };

                const res = await fetch('/predict-pass', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await handleResponse(res);

                if(result.message) {
                    document.getElementById('skyplot').innerText = result.message;
                } else {
                    document.getElementById('skyplot').innerHTML = ''; // Clear
                    drawSkyplot(result.points);
                    const info = document.createElement('div');
                    info.innerHTML = `<p>AOS: ${result.aos}</p><p>LOS: ${result.los}</p><p>Max El: ${result.max_el.toFixed(2)}</p>`;
                    document.getElementById('skyplot').appendChild(info);
                }
            } catch (err) {
                console.error(err);
                document.getElementById('skyplot').innerText = `Error: ${err.message}`;
            } finally {
                btn.disabled = false;
                btn.removeAttribute('aria-busy');
                btn.innerText = originalText;
            }
        });

        // IQ Form Handler
        document.getElementById('iq-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.setAttribute('aria-busy', 'true');
            btn.innerHTML = '<span class="spinner"></span> Visualizing...';
            document.getElementById('iq-status').innerText = '';

            try {
                const data = {
                    scheme: document.getElementById('scheme').value,
                    snr_db: parseFloat(document.getElementById('snr').value)
                };

                const res = await fetch('/generate-iq', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await handleResponse(res);

                if(result.iq_data) {
                    drawConstellation(result.iq_data);
                    document.getElementById('iq-status').innerText = 'Constellation updated.';
                } else {
                    // Backend returns {error: "..."} on some logic errors even with 200 OK?
                    // Check logic in index.py:
                    // except ValueError as e: return {"error": str(e)}
                    // So we handle it here.
                     if (result.error) {
                        document.getElementById('iq-status').innerText = 'Error: ' + result.error;
                    }
                }
            } catch (err) {
                console.error(err);
                document.getElementById('iq-status').innerText = `Error: ${err.message}`;
            } finally {
                btn.disabled = false;
                btn.removeAttribute('aria-busy');
                btn.innerText = originalText;
            }
        });

        // --- UX Helpers ---
        function formatFrequency(hz) {
            if (!hz) return '';
            if (hz >= 1e9) return ` (${(hz/1e9).toFixed(2)} GHz)`;
            if (hz >= 1e6) return ` (${(hz/1e6).toFixed(2)} MHz)`;
            if (hz >= 1e3) return ` (${(hz/1e3).toFixed(2)} kHz)`;
            return '';
        }

        function formatPower(dbm) {
            if (dbm === '' || isNaN(dbm)) return '';
            const watts = Math.pow(10, (dbm - 30) / 10);
            if (watts >= 1) return ` (${watts.toFixed(2)} W)`;
            if (watts >= 1e-3) return ` (${(watts*1e3).toFixed(2)} mW)`;
            return ` (${(watts*1e6).toFixed(2)} ÂµW)`;
        }

        function formatRate(bps) {
            if (!bps) return '';
            if (bps >= 1e6) return ` (${(bps/1e6).toFixed(2)} Mbps)`;
            if (bps >= 1e3) return ` (${(bps/1e3).toFixed(2)} kbps)`;
            return '';
        }

        function attachHelper(inputId, helperId, formatter) {
            const input = document.getElementById(inputId);
            const helper = document.getElementById(helperId);
            if (!input || !helper) return;
            const update = () => helper.textContent = formatter(parseFloat(input.value));
            input.addEventListener('input', update);
            update(); // Initial call
        }

        attachHelper('freq', 'freq-helper', formatFrequency);
        attachHelper('tx_pwr', 'pwr-helper', formatPower);
        attachHelper('rate', 'rate-helper', formatRate);
    </script>
</body>
</html>
